<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-SHOP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for animations and styles -->
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #111827;
        }
        body {
            font-family: 'Inter', 'Hind+Siliguri', sans-serif;
            background-color: #f8fafc;
            color: var(--secondary-color);
        }
        /* Animation for cart icon shake */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Custom scrollbar for category container */
        .category-scrollbar::-webkit-scrollbar {
            height: 4px;
        }
        .category-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .category-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }

        /* Image zoom effect */
        .zoom-container {
            overflow: hidden;
            position: relative;
        }
        .zoom-container img {
            transition: transform 0.3s ease;
        }
        
        /* Transition for view changes */
        .view {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .view-hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: -1;
        }
        /* Custom styles for payment modal themes */
        #payment-page-2.bkash-theme {
            background-color: #f14897;
            color: white;
            transition: background-color 0.3s ease;
        }
        #payment-page-2.nagad-theme {
            background-color: #f15624;
            color: white;
            transition: background-color 0.3s ease;
        }
        #payment-page-2.bkash-theme label,
        #payment-page-2.nagad-theme label,
        #payment-page-2.bkash-theme p,
        #payment-page-2.nagad-theme p {
            color: white;
        }
        #payment-page-2.bkash-theme input,
        #payment-page-2.nagad-theme input {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
            color: white;
        }
        #payment-page-2.bkash-theme input::placeholder,
        #payment-page-2.nagad-theme input::placeholder {
            color: rgba(255, 255, 255, 0.8);
        }
         #payment-page-2.bkash-theme #payment-number,
        #payment-page-2.nagad-theme #payment-number {
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
        }
        .tab-button.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        #banner-section {
             height: auto;
        }
        @media (min-width: 768px) {
            #banner-section {
                height: 60vh;
                max-height: 500px;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="relative overflow-x-hidden">

        <!-- ======================================================= -->
        <!-- ===================== HEADER ========================== -->
        <!-- ======================================================= -->
        <header id="main-header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <button id="back-button" class="hidden text-gray-600 hover:text-indigo-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <a href="#" id="brand-logo" class="text-3xl font-bold text-indigo-600 tracking-wider">E-SHOP</a>
                    </div>
                    <div id="header-icons" class="flex items-center space-x-5 sm:space-x-8">
                        <button id="cart-icon" class="relative text-gray-500 hover:text-indigo-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span id="cart-count" class="absolute -top-2 -right-3 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
                        </button>
                        <button id="profile-icon" class="relative text-gray-500 hover:text-indigo-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ======================================================= -->
        <!-- ===================== MAIN PAGE VIEW ================== -->
        <!-- ======================================================= -->
        <main id="main-page-view" class="view">
            <!-- Banner Section -->
            <section id="banner-section" class="relative w-full overflow-hidden">
                <div id="banner-container" class="flex transition-transform duration-500 ease-in-out h-full">
                    <!-- Banners will be injected by JS -->
                </div>
                <button id="prev-banner" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/50 hover:bg-white/80 p-3 rounded-full shadow-lg transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button id="next-banner" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/50 hover:bg-white/80 p-3 rounded-full shadow-lg transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </section>

            <!-- Category Filter Section -->
            <section id="category-section" class="bg-white sticky top-20 z-30 shadow-sm py-3">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center">
                        <button id="prev-cat" class="p-2 rounded-full hover:bg-gray-200 transition hidden md:hidden mr-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div id="category-container" class="flex space-x-3 overflow-x-auto category-scrollbar whitespace-nowrap">
                            <!-- Category buttons will be injected by JS -->
                        </div>
                        <button id="next-cat" class="p-2 rounded-full hover:bg-gray-200 transition hidden md:hidden ml-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Product Grid Section -->
            <section id="product-grid-section" class="py-12 bg-gray-50">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <h2 id="product-section-title" class="text-3xl font-bold mb-8 text-center" data-lang-key="allProducts">All Products</h2>
                    <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="col-span-full flex justify-center items-center h-64">
                            <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <!-- Product cards will be injected by JS -->
                    </div>
                </div>
            </section>
        </main>


        <!-- ======================================================= -->
        <!-- ================ PRODUCT DETAIL VIEW ================== -->
        <!-- ======================================================= -->
        <div id="product-detail-view" class="view view-hidden">
            <!-- Product detail content will be injected by JS -->
        </div>


        <!-- ======================================================= -->
        <!-- ================= CHECKOUT VIEW ======================= -->
        <!-- ======================================================= -->
        <div id="checkout-view" class="view view-hidden">
            <!-- Checkout form will be injected by JS -->
        </div>
        
        <!-- ======================================================= -->
        <!-- ===================== FOOTER ========================== -->
        <!-- ======================================================= -->
        <footer class="bg-gray-800 text-white pt-16 pb-8">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <!-- Brand Info -->
                    <div class="md:col-span-1">
                        <h3 class="text-2xl font-bold text-indigo-400 mb-4">E-SHOP</h3>
                        <p id="footer-brand-info" class="text-gray-400 text-sm leading-relaxed">
                            Loading...
                        </p>
                    </div>
                    <!-- Information -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4 tracking-wide">Information</h4>
                        <ul id="footer-info-links" class="space-y-2 text-gray-400 text-sm">
                           <!-- Links will be injected here -->
                        </ul>
                    </div>
                    <!-- Guidelines -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4 tracking-wide">Guidelines</h4>
                        <ul id="footer-guidelines-links" class="space-y-2 text-gray-400 text-sm">
                            <!-- Links will be injected here -->
                        </ul>
                    </div>
                    <!-- Follow Us -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4 tracking-wide">Follow Us</h4>
                        <div id="footer-social-links" class="flex space-x-4">
                            <!-- Social Icons will be injected here -->
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-8 border-t border-gray-700 text-center text-gray-500 text-sm">
                    &copy; <span id="current-year"></span> E-SHOP. All Rights Reserved.
                </div>
            </div>
        </footer>

    </div>

    <!-- ======================================================= -->
    <!-- ===================== CART SLIDEOUT =================== -->
    <!-- ======================================================= -->
    <div id="cart-overlay" class="fixed inset-0 bg-black/50 z-40 transition-opacity opacity-0 pointer-events-none"></div>
    <div id="cart-slideout" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col h-full">
            <!-- Cart Header -->
            <div class="flex items-center justify-between p-5 border-b">
                <h2 class="text-xl font-semibold" data-lang-key="yourCart">Your Cart</h2>
                <button id="close-cart" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Cart Items -->
            <div id="cart-items-container" class="flex-grow p-5 overflow-y-auto">
                <!-- Cart items will be injected here -->
                <div id="empty-cart-message" class="text-center text-gray-500 mt-20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <p class="mt-4" data-lang-key="emptyCart">Your cart is empty.</p>
                </div>
            </div>
            <!-- Cart Footer -->
            <div class="p-5 border-t bg-gray-50">
                <div class="flex justify-between items-center mb-4 font-semibold">
                    <span data-lang-key="subtotal">Subtotal</span>
                    <span id="cart-subtotal">BDT 0</span>
                </div>
                <button id="confirm-order-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed" data-lang-key="confirmOrder">
                    Confirm Order
                </button>
            </div>
        </div>
    </div>
    
    <!-- ======================================================= -->
    <!-- ================= PAYMENT POPUP MODAL ================= -->
    <!-- ======================================================= -->
    <div id="payment-modal-overlay" class="fixed inset-0 bg-black/60 z-50 transition-opacity opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div id="payment-modal" class="bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 opacity-0 transition-all duration-300">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <button id="payment-modal-back" class="text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="payment-modal-title" class="text-lg font-semibold" data-lang-key="paymentMethods">Payment Methods</h2>
                <div class="w-6 h-6"></div> <!-- Spacer -->
            </div>
            <!-- Modal Content -->
            <div class="relative overflow-hidden">
                <div id="payment-modal-content" class="flex transition-transform duration-300 ease-in-out">
                    <!-- Page 1: Method Selection -->
                    <div id="payment-page-1" class="w-full flex-shrink-0 p-6 space-y-4">
                        <button data-method="Bkash" class="payment-method-btn w-full text-left flex items-center p-4 border rounded-lg hover:bg-gray-50 transition">
                            <img src="https://placehold.co/40x40/E2136E/FFFFFF?text=B" alt="Bkash" class="w-10 h-10 rounded-md mr-4">
                            <span class="font-semibold text-lg" data-lang-key="bkash">Bkash</span>
                        </button>
                        <button data-method="Nagad" class="payment-method-btn w-full text-left flex items-center p-4 border rounded-lg hover:bg-gray-50 transition">
                             <img src="https://placehold.co/40x40/F54D2D/FFFFFF?text=N" alt="Nagad" class="w-10 h-10 rounded-md mr-4">
                            <span class="font-semibold text-lg" data-lang-key="nagad">Nagad</span>
                        </button>
                    </div>
                    <!-- Page 2: Transaction Form -->
                    <div id="payment-page-2" class="w-full flex-shrink-0 p-6">
                        <div class="text-center mb-4">
                            <p class="text-gray-600" data-lang-key="sendMoneyTo">Send money to the number below</p>
                            <p id="payment-number" class="text-xl font-bold text-indigo-600 tracking-widest py-2 bg-gray-100 rounded-md mt-2">01700000000</p>
                        </div>
                        <form id="payment-form" class="space-y-4">
                            <div>
                                <label for="trxID" class="block text-sm font-medium text-gray-700" data-lang-key="trxID">Transaction ID</label>
                                <input type="text" id="trxID" required class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="senderNumber" class="block text-sm font-medium text-gray-700" data-lang-key="senderNumber">Your Number</label>
                                <input type="text" id="senderNumber" required class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                             <div>
                                <label for="paymentAmount" class="block text-sm font-medium text-gray-700" data-lang-key="amount">Amount</label>
                                <input type="number" id="paymentAmount" readonly required class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-100">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-semibold hover:bg-indigo-700 transition" data-lang-key="submit">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ======================================================= -->
    <!-- ================== AUTH MODAL & TEXT MODAL ============ -->
    <!-- ======================================================= -->
    <div id="modal-overlay-generic" class="fixed inset-0 bg-black/60 z-50 transition-opacity opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div id="modal-generic" class="bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 relative">
             <div id="modal-generic-content"></div>
        </div>
    </div>


    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, getDoc, addDoc, updateDoc, deleteDoc, writeBatch, query, where, serverTimestamp, runTransaction, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // State & Firebase Refs
        let siteSettings = {};
        let products = [];
        let categories = [];
        let banners = [];
        let cart = [];
        let currentBannerIndex = 0, currentView = 'main', paymentModalPage = 1;
        let db, auth, userId, isAnonymous, unsubscribeCartListener;
        let tempAnonymousUserId = null;
        let paymentTransactionDetails = null; 
        
        // Element Selectors
        const loadingSpinner = document.getElementById('loading-spinner');
        const productGrid = document.getElementById('product-grid'), categoryContainer = document.getElementById('category-container'), bannerContainer = document.getElementById('banner-container'), mainPageView = document.getElementById('main-page-view'), productDetailView = document.getElementById('product-detail-view'), checkoutView = document.getElementById('checkout-view'), backButton = document.getElementById('back-button'), brandLogo = document.getElementById('brand-logo');
        const cartIcon = document.getElementById('cart-icon'), cartCount = document.getElementById('cart-count'), cartOverlay = document.getElementById('cart-overlay'), cartSlideout = document.getElementById('cart-slideout'), closeCartBtn = document.getElementById('close-cart'), cartItemsContainer = document.getElementById('cart-items-container'), emptyCartMessage = document.getElementById('empty-cart-message'), cartSubtotalEl = document.getElementById('cart-subtotal'), confirmOrderBtn = document.getElementById('confirm-order-btn');
        const paymentModalOverlay = document.getElementById('payment-modal-overlay'), paymentModal = document.getElementById('payment-modal'), paymentModalBack = document.getElementById('payment-modal-back'), paymentModalTitle = document.getElementById('payment-modal-title'), paymentModalContent = document.getElementById('payment-modal-content'), paymentForm = document.getElementById('payment-form');
        const genericModalOverlay = document.getElementById('modal-overlay-generic'), genericModal = document.getElementById('modal-generic'), genericModalContent = document.getElementById('modal-generic-content'), profileIcon = document.getElementById('profile-icon');

        // ==== EVENT HANDLERS & LOGIC ====
        const handleCategoryFilter = (e) => {
            const selectedCategory = e.target.dataset.category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-gray-900', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            e.target.classList.add('bg-gray-900', 'text-white');
            e.target.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            
            document.getElementById('product-section-title').textContent = selectedCategory === 'All' ? 'All Products' : `${selectedCategory} Collection`;

            const filtered = selectedCategory === 'All' ? products : products.filter(p => p.category === selectedCategory);
            renderProducts(filtered);
        };

        const setupProductDetailListeners = (product) => {
            const quantityInput = document.getElementById('quantity-input');
            const plusBtn = productDetailView.querySelector('.quantity-plus');
            const minusBtn = productDetailView.querySelector('.quantity-minus');
            const sizeBtns = productDetailView.querySelectorAll('.size-btn');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const zoomContainer = document.querySelector('.zoom-container');
            const zoomImage = document.getElementById('main-product-image');

            plusBtn.addEventListener('click', () => { quantityInput.value = parseInt(quantityInput.value) + 1; });
            minusBtn.addEventListener('click', () => { if (parseInt(quantityInput.value) > 1) { quantityInput.value = parseInt(quantityInput.value) - 1; } });

            let selectedSize = product.sizes[0];
            sizeBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    sizeBtns.forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                        b.classList.add('bg-white', 'text-gray-700');
                    });
                    e.currentTarget.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                    e.currentTarget.classList.remove('bg-white', 'text-gray-700');
                    selectedSize = e.currentTarget.dataset.size;
                });
            });

            addToCartBtn.addEventListener('click', () => { addToCart(product.id, parseInt(quantityInput.value), selectedSize); });
            
            if(zoomContainer && zoomImage) {
                zoomContainer.addEventListener('mousemove', (e) => {
                    const { left, top, width, height } = e.currentTarget.getBoundingClientRect();
                    const x = (e.clientX - left) / width * 100;
                    const y = (e.clientY - top) / height * 100;
                    zoomImage.style.transformOrigin = `${x}% ${y}%`;
                    zoomImage.style.transform = 'scale(2)';
                });
                zoomContainer.addEventListener('mouseleave', () => { zoomImage.style.transform = 'scale(1)'; });
            }
        };
        
        // ==== RENDERING FUNCTIONS ====
        const renderProducts = (filteredProducts) => {
            productGrid.innerHTML = '';
            if(!products || products.length === 0){
                if (!document.querySelector('#product-grid p')) { 
                   loadingSpinner.classList.remove('hidden');
                }
                return;
            }
            loadingSpinner.classList.add('hidden');
            (filteredProducts || products).forEach(product => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden group transform hover:-translate-y-2 transition-all duration-300 cursor-pointer';
                const price = `BDT ${product.price.toLocaleString('en-US')}`;
                card.innerHTML = `<div class="relative"><img src="${product.image}" alt="${product.name}" class="w-full h-56 sm:h-64 object-cover transition-transform duration-300 group-hover:scale-110"></div><div class="p-4"><h3 class="font-semibold text-lg truncate">${product.name}</h3><p class="text-indigo-600 font-bold mt-2 text-xl">${price}</p></div>`;
                card.addEventListener('click', () => showProductDetail(product.id));
                productGrid.appendChild(card);
            });
        };
        
        const renderCategories = () => {
            const currentActive = categoryContainer.querySelector('.category-btn.bg-gray-900')?.dataset.category || 'All';
            categoryContainer.innerHTML = '';
            ['All', ...categories].forEach(categoryName => {
                const button = document.createElement('button');
                button.textContent = categoryName; 
                button.dataset.category = categoryName;
                button.className = 'category-btn px-5 py-2 text-sm font-semibold rounded-full transition-colors duration-300';
                if (categoryName === currentActive) { button.classList.add('bg-gray-900', 'text-white'); } else { button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300'); }
                button.addEventListener('click', handleCategoryFilter);
                categoryContainer.appendChild(button);
            });
            checkCategoryOverflow();
        };

        const renderBanners = () => {
            bannerContainer.innerHTML = '';
             if (banners.length === 0) {
                bannerContainer.innerHTML = `<div class="w-full h-full flex-shrink-0 bg-gray-200 flex items-center justify-center"><p class="text-gray-500">No banners available.</p></div>`;
                return;
            }
            banners.forEach(banner => {
                const bannerEl = document.createElement('div'); bannerEl.className = 'w-full h-full flex-shrink-0 bg-cover bg-center relative cursor-pointer'; bannerEl.style.backgroundImage = `url(${banner.img})`; bannerEl.innerHTML = `<div class="absolute inset-0 bg-black/40"></div>`; bannerEl.dataset.category = banner.category;
                bannerEl.addEventListener('click', () => {
                    const categorySection = document.getElementById(`category-section`);
                    if (categorySection) { const targetCategory = document.querySelector(`.category-btn[data-category="${banner.category}"]`); if(targetCategory) targetCategory.click(); categorySection.scrollIntoView({ behavior: 'smooth' }); }
                });
                bannerContainer.appendChild(bannerEl);
            });
        };

        const showProductDetail = (productId, pushState = true) => {
            const product = products.find(p => p.id === productId); if (!product) return;
            const price = `BDT ${product.price.toLocaleString('en-US')}`;
            const sizeGuideContent = (product.sizeGuide || '').replace(/\n/g, '<br>');
            productDetailView.innerHTML = `<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12"><div><div class="zoom-container rounded-lg shadow-lg mb-4 bg-gray-100"><img id="main-product-image" src="${product.images[0]}" alt="${product.name}" class="w-full h-auto object-cover rounded-lg cursor-zoom-in"></div><div id="thumbnail-container" class="grid grid-cols-5 gap-2">${product.images.map((img, index) => `<img src="${img}" class="w-full h-20 object-cover rounded-md cursor-pointer border-2 ${index === 0 ? 'border-indigo-500' : 'border-transparent'} hover:border-indigo-400 transition" onclick="changeMainImage('${img}', this)">`).join('')}</div></div><div class="flex flex-col justify-center"><h1 class="text-3xl md:text-4xl font-bold mb-2">${product.name}</h1><p class="text-gray-500 mb-4">Product ID: ESHOP-${String(product.id).padStart(4, '0')}</p><p class="text-4xl font-bold text-indigo-600 mb-6">${price}</p><div class="mb-6"><label class="font-semibold text-lg mb-2 block">Size</label><div class="flex flex-wrap gap-2">${product.sizes.map((size, index) => `<button class="size-btn px-4 py-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition ${index === 0 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700'}" data-size="${size}">${size}</button>`).join('')}</div></div><div class="mb-6"><label class="font-semibold text-lg mb-2 block">Quantity</label><div class="flex items-center border rounded-lg w-32"><button class="quantity-minus p-3 text-gray-600 hover:bg-gray-100 rounded-l-lg">-</button><input id="quantity-input" type="text" value="1" class="w-full text-center font-bold border-none focus:ring-0"><button class="quantity-plus p-3 text-gray-600 hover:bg-gray-100 rounded-r-lg">+</button></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"><button id="add-to-cart-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>Add to Cart</button><a id="whatsapp-order-btn" href="#" target="_blank" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition flex items-center justify-center gap-2"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.905 6.166l-1.138 4.162 4.273-1.12z" /></svg>Order on WhatsApp</a></div><div class="border-t pt-4"><details class="group py-2" open><summary class="flex justify-between items-center font-medium cursor-pointer list-none"><span class="text-lg">Product Details</span></summary><p class="text-gray-600 mt-3 group-open:animate-fadeIn">${product.description}</p></details><details class="group py-2"><summary class="flex justify-between items-center font-medium cursor-pointer list-none"><span class="text-lg">Size Guide</span></summary><p class="text-gray-600 mt-3 group-open:animate-fadeIn">${sizeGuideContent}</p></details></div></div></div></div><section class="py-12 bg-gray-50"><div class="container mx-auto px-4 sm:px-6 lg:px-8"><h2 class="text-3xl font-bold mb-8 text-center">Similar Products</h2><div id="similar-product-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8"></div></div></section>`;
            document.getElementById('whatsapp-order-btn').href = `https://wa.me/${siteSettings.whatsappNumber || ''}?text=I'm%20interested%20in%20product%20ID:%20ESHOP-${String(product.id).padStart(4, '0')}`;
            const similarGrid = productDetailView.querySelector('#similar-product-grid');
            products.filter(p => p.category === product.category && p.id !== product.id).slice(0, 4).forEach(p => {
                 const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow-lg overflow-hidden group transform hover:-translate-y-2 transition-all duration-300 cursor-pointer';
                 const similarPrice = `BDT ${p.price.toLocaleString('en-US')}`;
                card.innerHTML = `<div class="relative"><img src="${p.image}" alt="${p.name}" class="w-full h-56 sm:h-64 object-cover transition-transform duration-300 group-hover:scale-110"></div><div class="p-4"><h3 class="font-semibold text-lg truncate">${p.name}</h3><p class="text-indigo-600 font-bold mt-2 text-xl">${similarPrice}</p></div>`;
                card.addEventListener('click', () => showProductDetail(p.id));
                similarGrid.appendChild(card);
            });
            setupProductDetailListeners(product);
            if (pushState) switchView('detail', { productId });
        };
        
        const showCheckout = (pushState = true) => {
            closeCart();
            paymentTransactionDetails = null;
            const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
            const subtotalText = `BDT ${subtotal.toLocaleString('en-US')}`;
            const mobilePrefix = '01';
            const deliveryInsideText = `BDT 70`;
            const deliveryOutsideText = `BDT 130`;

            let paymentOptionsHTML = '';
            if (siteSettings.enableCOD) {
                paymentOptionsHTML += `<label class="flex items-center"><input type="radio" name="payment" value="cod" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border border-gray-400" checked><span class="ml-3">Cash on Delivery</span></label>`;
            }
             if (siteSettings.enableMobileBanking) {
                paymentOptionsHTML += `<label class="flex items-center"><input type="radio" name="payment" value="mobile" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border border-gray-400" ${!siteSettings.enableCOD ? 'checked' : ''}><span class="ml-3">Mobile Banking</span></label>`;
            }

            checkoutView.innerHTML = `<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12"><h1 class="text-3xl md:text-4xl font-bold mb-8 text-center">Complete Order</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 bg-white p-8 rounded-lg shadow-md"><h2 class="text-xl font-semibold mb-6">Billing Details</h2><form id="checkout-form" class="space-y-6"><div><label for="fullName" class="block text-sm font-medium text-gray-700">Full Name *</label><input type="text" id="fullName" name="fullName" required class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div><div><label for="mobileNumber" class="block text-sm font-medium text-gray-700">Mobile Number *</label><div class="flex mt-1"><span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-400 bg-gray-50 text-gray-500 text-sm">${mobilePrefix}</span><input type="tel" id="mobileNumber" name="mobileNumber" required maxlength="9" pattern="[3-9]{1}[0-9]{8}" placeholder="........." class="flex-1 block w-full border border-gray-400 rounded-none rounded-r-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div><p class="text-xs text-gray-500 mt-1">Enter the last 9 digits of your 11-digit number.</p></div><div><label for="address" class="block text-sm font-medium text-gray-700">Full Address *</label><textarea id="address" name="address" rows="3" required class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea></div><div><label for="comments" class="block text-sm font-medium text-gray-700">Special Comments (Optional)</label><textarea id="comments" name="comments" rows="2" class="mt-1 block w-full border border-gray-400 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea></div></form></div><div class="lg:col-span-1 bg-white p-8 rounded-lg shadow-md"><h2 class="text-xl font-semibold mb-6">Your Order</h2><div id="order-summary" class="space-y-4"><div class="flex justify-between border-b pb-2"><span>Product</span><span>Total</span></div>${cart.map(item => `<div class="flex justify-between text-sm"><span class="text-gray-600">${item.name} Ã— ${item.quantity}</span><span class="font-medium">${`BDT ${(item.price * item.quantity).toLocaleString('en-US')}`}</span></div>`).join('')}<div class="flex justify-between font-semibold border-t pt-2"><span>Subtotal</span><span>${subtotalText}</span></div></div><div class="mt-6 border-t pt-6"><h3 class="font-semibold mb-2">Delivery Charge</h3><div class="space-y-2"><label class="flex items-center"><input type="radio" name="delivery" value="70" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border border-gray-400" checked><span class="ml-3">Inside Dhaka: ${deliveryInsideText}</span></label><label class="flex items-center"><input type="radio" name="delivery" value="130" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border border-gray-400"><span class="ml-3">Outside Dhaka: ${deliveryOutsideText}</span></label></div></div><div class="mt-6 border-t pt-6"><h3 class="font-semibold mb-2">Coupon Code</h3><div class="flex"><input type="text" id="coupon-code" placeholder="Coupon Code" class="flex-1 block w-full border border-gray-400 rounded-none rounded-l-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><button id="apply-coupon-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-r-md hover:bg-gray-300">Apply</button></div><p id="coupon-message" class="text-sm mt-2"></p></div><div class="mt-6 border-t pt-6 font-bold text-lg flex justify-between"><span>Grand Total</span><span id="grand-total"></span></div><div class="mt-6 border-t pt-6"><h3 class="font-semibold mb-2">Payment Method</h3><div class="space-y-2 p-4 bg-gray-100 rounded-md">${paymentOptionsHTML}</div></div><button id="place-order-btn" class="mt-8 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Place Order</button></div></div></div>`;
            setupCheckoutListeners(subtotal);
            if (pushState) switchView('checkout');
        };

        const setupCheckoutListeners = (subtotal) => {
            const deliveryRadios = document.querySelectorAll('input[name="delivery"]'), grandTotalEl = document.getElementById('grand-total'), couponBtn = document.getElementById('apply-coupon-btn'), couponInput = document.getElementById('coupon-code'), couponMsg = document.getElementById('coupon-message'), placeOrderBtn = document.getElementById('place-order-btn'), checkoutForm = document.getElementById('checkout-form'), paymentRadios = document.querySelectorAll('input[name="payment"]');
            let deliveryCharge = 70, discount = 0;
            const updateTotal = () => { const total = subtotal + deliveryCharge - discount; grandTotalEl.textContent = `BDT ${total.toLocaleString('en-US')}`; };
            deliveryRadios.forEach(radio => radio.addEventListener('change', (e) => { deliveryCharge = parseInt(e.target.value); updateTotal(); }));
            couponBtn.addEventListener('click', async () => { 
                const couponCode = couponInput.value.trim().toUpperCase();
                if (!couponCode) { couponMsg.textContent = 'Please enter a coupon code.'; couponMsg.className = 'text-sm mt-2 text-red-600'; return; }
                const couponRef = doc(db, 'coupons', couponCode);
                const couponSnap = await getDoc(couponRef);
                if (couponSnap.exists() && couponSnap.data().active) {
                    const couponData = couponSnap.data();
                    discount = subtotal * (couponData.discountPercentage / 100);
                    couponMsg.textContent = `Coupon '${couponCode}' applied! You got a ${couponData.discountPercentage}% (BDT ${discount.toFixed(2)}) discount.`;
                    couponMsg.className = 'text-sm mt-2 text-green-600';
                    updateTotal();
                } else {
                    discount = 0;
                    couponMsg.textContent = 'Invalid or expired coupon code.';
                    couponMsg.className = 'text-sm mt-2 text-red-600';
                    updateTotal();
                }
            });
            
            placeOrderBtn.addEventListener('click', async () => { 
                if(!checkoutForm.checkValidity()){ checkoutForm.reportValidity(); return; }
                const selectedPaymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
                if (selectedPaymentMethod === 'mobile' && !paymentTransactionDetails) {
                    alert('Please submit your mobile banking transaction details first.');
                    openPaymentModal(subtotal + deliveryCharge - discount);
                    return;
                }
                const orderData = {
                    userId, fullName: checkoutForm.fullName.value, mobileNumber: `01${checkoutForm.mobileNumber.value}`, address: checkoutForm.address.value, comments: checkoutForm.comments.value,
                    deliveryCharge, discount, subtotal, grandTotal: subtotal + deliveryCharge - discount,
                    paymentMethod: selectedPaymentMethod, items: cart, status: 'pending', createdAt: serverTimestamp()
                };
                if (!isAnonymous) orderData.customerEmail = auth.currentUser.email;
                if (orderData.paymentMethod === 'mobile') orderData.paymentDetails = paymentTransactionDetails;

                try {
                    await addDoc(collection(db, `orders`), orderData);
                    const cartCollectionRef = collection(db, `users/${userId}/cart`);
                    const batch = writeBatch(db);
                    const cartSnapshot = await getDocs(cartCollectionRef);
                    cartSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    alert('Order placed successfully!'); 
                    switchView('main');
                } catch (error) { console.error("Error placing order: ", error); alert("Failed to place order."); }
            });

            if(paymentRadios && paymentRadios.length > 0) {
                paymentRadios.forEach(radio => radio.addEventListener('change', e => { 
                    if (e.target.value === 'mobile') { 
                        paymentTransactionDetails = null; 
                        const total = subtotal + deliveryCharge - discount; 
                        openPaymentModal(total); 
                    } 
                }));
            }
            document.getElementById('mobileNumber').addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
            updateTotal();
        };

        const switchView = (view, state = {}) => {
            window.scrollTo(0, 0); currentView = view;
            mainPageView.classList.add('view-hidden'); productDetailView.classList.add('view-hidden'); checkoutView.classList.add('view-hidden');
            if (view === 'main') { mainPageView.classList.remove('view-hidden'); backButton.classList.add('hidden'); history.pushState({ page: 'main' }, '', '#');
            } else if (view === 'detail') { productDetailView.classList.remove('view-hidden'); backButton.classList.remove('hidden'); history.pushState({ page: 'detail', productId: state.productId }, '', `#product/${state.productId}`);
            } else if (view === 'checkout') { checkoutView.classList.remove('view-hidden'); backButton.classList.remove('hidden'); history.pushState({ page: 'checkout' }, '', '#checkout'); }
        };
        backButton.addEventListener('click', () => switchView('main'));
        brandLogo.addEventListener('click', (e) => { e.preventDefault(); if (currentView !== 'main') switchView('main'); });
        window.addEventListener('popstate', (e) => { if (e.state) { if (e.state.page === 'main') { switchView('main'); } else if (e.state.page === 'detail') { showProductDetail(e.state.productId); } else if (e.state.page === 'checkout') { showCheckout(); } } else { switchView('main'); } });

        const showBanner = (index) => { if (banners.length > 0) { currentBannerIndex = (index + banners.length) % banners.length; bannerContainer.style.transform = `translateX(${-currentBannerIndex * 100}%)`; }};
        document.getElementById('next-banner').addEventListener('click', () => showBanner(currentBannerIndex + 1)); document.getElementById('prev-banner').addEventListener('click', () => showBanner(currentBannerIndex - 1)); setInterval(() => showBanner(currentBannerIndex + 1), 3000);
        
        const checkCategoryOverflow = () => { if (categoryContainer.scrollWidth > categoryContainer.clientWidth) { document.getElementById('prev-cat').classList.remove('hidden'); document.getElementById('next-cat').classList.remove('hidden'); } };
        document.getElementById('next-cat').addEventListener('click', () => { categoryContainer.scrollBy({ left: 150, behavior: 'smooth' }); }); document.getElementById('prev-cat').addEventListener('click', () => { categoryContainer.scrollBy({ left: -150, behavior: 'smooth' }); });

        const openCart = () => { cartOverlay.classList.remove('opacity-0', 'pointer-events-none'); cartSlideout.classList.remove('translate-x-full'); };
        const closeCart = () => { cartOverlay.classList.add('opacity-0', 'pointer-events-none'); cartSlideout.classList.add('translate-x-full'); };
        
        const addToCart = async (productId, quantity, size) => { 
            if (!userId) return;
            const cartCollectionRef = collection(db, `users/${userId}/cart`);
            const product = products.find(p => p.id === productId);

            const q = query(cartCollectionRef, where("id", "==", productId), where("size", "==", size));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const docRef = querySnapshot.docs[0].ref;
                const newQuantity = querySnapshot.docs[0].data().quantity + quantity;
                await updateDoc(docRef, { quantity: newQuantity });
            } else {
                await addDoc(cartCollectionRef, { ...product, quantity, size });
            }
            cartIcon.classList.add('shake'); setTimeout(() => cartIcon.classList.remove('shake'), 820);
            openCart(); 
        };
        
        const updateCartUI = () => { 
            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0); 
            if (cart.length === 0) { 
                cartItemsContainer.innerHTML = ''; 
                cartItemsContainer.appendChild(emptyCartMessage); 
                confirmOrderBtn.disabled = true; 
            } else { 
                if(cartItemsContainer.contains(emptyCartMessage)) emptyCartMessage.remove(); 
                cartItemsContainer.innerHTML = cart.map(item => { 
                    const price = `BDT ${item.price.toLocaleString('en-US')}`; 
                    return `<div class="flex items-start gap-4 mb-4" data-doc-id="${item.docId}"><img src="${item.image}" alt="${item.name}" class="w-20 h-24 object-cover rounded-md"><div class="flex-grow"><h4 class="font-semibold">${item.name}</h4><p class="text-sm text-gray-500">Size: ${item.size}</p><p class="font-bold text-indigo-600">${price}</p><div class="flex items-center border rounded-md w-28 mt-2"><button class="cart-quantity-minus p-2 text-gray-500 hover:bg-gray-100">-</button><input type="text" value="${item.quantity}" class="w-full text-center font-semibold border-none focus:ring-0" readonly><button class="cart-quantity-plus p-2 text-gray-500 hover:bg-gray-100">+</button></div></div><button class="cart-item-remove text-gray-400 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>` 
                }).join(''); 
                confirmOrderBtn.disabled = false; 
            } 
            const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0); 
            cartSubtotalEl.textContent = `BDT ${subtotal.toLocaleString('en-US')}`; 
            document.querySelectorAll('.cart-quantity-plus').forEach(b => b.addEventListener('click', (e) => updateCartItemQuantity(e, 1))); 
            document.querySelectorAll('.cart-quantity-minus').forEach(b => b.addEventListener('click', (e) => updateCartItemQuantity(e, -1))); 
            document.querySelectorAll('.cart-item-remove').forEach(b => b.addEventListener('click', removeCartItem)); 
        };

        const updateCartItemQuantity = async (e, change) => { 
            if (!userId) return;
            const el = e.target.closest('[data-doc-id]');
            const docId = el.dataset.docId;
            const item = cart.find(i => i.docId === docId);
            if (item) {
                const newQuantity = item.quantity + change;
                const docRef = doc(db, `users/${userId}/cart`, docId);
                if (newQuantity <= 0) {
                    await deleteDoc(docRef);
                } else {
                    await updateDoc(docRef, { quantity: newQuantity });
                }
            }
        };

        const removeCartItem = async (e) => { 
            if (!userId) return;
            const el = e.target.closest('[data-doc-id]');
            const docId = el.dataset.docId;
            const docRef = doc(db, `users/${userId}/cart`, docId);
            await deleteDoc(docRef);
        };
        
        cartIcon.addEventListener('click', openCart); 
        closeCartBtn.addEventListener('click', closeCart); 
        cartOverlay.addEventListener('click', closeCart); 
        confirmOrderBtn.addEventListener('click', () => { 
            if (cart.length > 0) {
                showCheckout();
            }
        });
        
        const openPaymentModal = (total) => {
            paymentTransactionDetails = null;
            document.getElementById('paymentAmount').value = total;
            const paymentNumberEl = document.getElementById('payment-number');
            if (document.querySelector('.payment-method-btn[data-method="Bkash"]')) {
                paymentNumberEl.textContent = siteSettings.bkashNumber || 'Not set';
            } else {
                 paymentNumberEl.textContent = siteSettings.nagadNumber || 'Not set';
            }
            paymentModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
            paymentModal.classList.remove('opacity-0', 'scale-95');
        };

        const closePaymentModal = () => { 
            const paymentPage2 = document.getElementById('payment-page-2');
            paymentModalOverlay.classList.add('opacity-0', 'pointer-events-none'); 
            paymentModal.classList.add('opacity-0', 'scale-95'); 
            setTimeout(() => { 
                goToPaymentPage(1); 
                paymentForm.reset();
                paymentPage2.classList.remove('bkash-theme', 'nagad-theme');
            }, 300); 
        };
        const goToPaymentPage = (page) => { paymentModalPage = page; paymentModalContent.style.transform = `translateX(-${(page - 1) * 100}%)`; };
        
        const setupPaymentModalListeners = () => {
            const paymentPage2 = document.getElementById('payment-page-2');
            paymentModalOverlay.addEventListener('click', (e) => { if (e.target === paymentModalOverlay) closePaymentModal(); });
            paymentModalBack.addEventListener('click', () => { 
                if (paymentModalPage === 2) { 
                    goToPaymentPage(1); 
                    paymentModalTitle.textContent = "Payment Methods";
                    paymentPage2.classList.remove('bkash-theme', 'nagad-theme');
                } else {
                    closePaymentModal();
                }
            });
            let currentProvider = '';
            document.getElementById('payment-page-1').addEventListener('click', e => {
                const btn = e.target.closest('.payment-method-btn');
                if (!btn) return;
                
                currentProvider = btn.dataset.method;
                const paymentNumberEl = document.getElementById('payment-number');
                paymentPage2.classList.remove('bkash-theme', 'nagad-theme');

                if (currentProvider === 'Bkash') {
                    paymentNumberEl.textContent = siteSettings.bkashNumber || 'N/A';
                    paymentPage2.classList.add('bkash-theme');
                } else if (currentProvider === 'Nagad') {
                    paymentNumberEl.textContent = siteSettings.nagadNumber || 'N/A';
                    paymentPage2.classList.add('nagad-theme');
                }
                
                paymentModalTitle.textContent = currentProvider;
                goToPaymentPage(2);
            });
            paymentForm.addEventListener('submit', e => { 
                e.preventDefault(); 
                if (paymentForm.checkValidity()) { 
                    paymentTransactionDetails = { 
                        provider: currentProvider,
                        trxId: document.getElementById('trxID').value, 
                        senderNumber: document.getElementById('senderNumber').value 
                    };
                    alert("Payment details submitted!"); 
                    closePaymentModal(); 
                } else { 
                    paymentForm.reportValidity(); 
                } 
            });
        };
        
        window.changeMainImage = (src, thumb) => { document.getElementById('main-product-image').src = src; document.querySelectorAll('#thumbnail-container img').forEach(img => img.classList.remove('border-indigo-500')); thumb.classList.add('border-indigo-500'); };
        
        // ==== AUTH & GENERIC MODAL FUNCTIONS ====
        window.showTextModal = (title, content) => {
            const formattedContent = content ? content.replace(/\n/g, '<br>') : 'No content available.';
            const modalHTML = `<div class="p-6"><div class="flex justify-between items-start"><h3 class="text-xl font-semibold text-gray-900">${title}</h3><button type="button" id="modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><div class="mt-4 text-gray-600">${formattedContent}</div></div>`;
            openGenericModal(modalHTML);
        }

        const openGenericModal = (content) => {
            genericModalContent.innerHTML = content;
            genericModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
            genericModal.classList.remove('opacity-0', 'scale-95');
            genericModal.querySelector('#modal-close-btn')?.addEventListener('click', closeGenericModal);
        };

        const closeGenericModal = () => {
            genericModalOverlay.classList.add('opacity-0', 'pointer-events-none');
            genericModal.classList.add('opacity-0', 'scale-95');
        };
        
        profileIcon.addEventListener('click', () => {
            const content = isAnonymous ? getAuthViewHTML('login') : getProfileViewHTML();
            openGenericModal(content);
            if (isAnonymous) {
                setupAuthFormListeners('login');
            } else {
                document.getElementById('logout-btn').addEventListener('click', async () => { await signOut(auth); closeGenericModal(); });
            }
        });

        const getProfileViewHTML = () => `<div class="p-8"><h2 class="text-2xl font-bold text-center mb-2">My Profile</h2><p class="text-center text-gray-600 mb-6">Welcome back!</p><div class="mb-4"><label class="block text-sm font-medium text-gray-500">Email</label><p class="text-lg font-semibold text-gray-800 break-all">${auth.currentUser.email}</p></div><button id="logout-btn" class="w-full mt-4 bg-red-500 text-white py-2.5 rounded-lg font-semibold hover:bg-red-600 transition">Logout</button></div>`;
        const getAuthViewHTML = (view) => `<div class="p-8"><div class="border-b border-gray-200 mb-6"><nav class="-mb-px flex space-x-6"><button id="login-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'login' ? 'active' : ''}" data-view="login">Login</button><button id="signup-tab" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'signup' ? 'active' : ''}" data-view="signup">Sign Up</button></nav></div><div id="auth-form-container"></div></div>`;
        const getAuthFormHTML = (view) => { const isLogin = view === 'login'; return `<h2 class="text-2xl font-bold text-center mb-2">${isLogin ? 'Welcome Back!' : 'Create Account'}</h2><p class="text-center text-gray-600 mb-6">${isLogin ? 'Login to continue' : 'Sign up'}</p><form id="auth-form" class="space-y-4"><div><label for="email" class="block text-sm font-medium">Email</label><input type="email" id="email" required class="mt-1 block w-full border border-gray-400 rounded-md p-2"></div><div><label for="password" class="block text-sm font-medium">Password</label><input type="password" id="password" required minlength="6" class="mt-1 block w-full border border-gray-400 rounded-md p-2"></div><p id="auth-error" class="text-sm text-red-500"></p><button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-semibold hover:bg-indigo-700">${isLogin ? 'Login' : 'Sign Up'}</button></form>`; };

        function setupAuthFormListeners(initialView) {
            const authFormContainer = genericModal.querySelector('#auth-form-container');
            authFormContainer.innerHTML = getAuthFormHTML(initialView);
            
            genericModal.querySelector('#login-tab').addEventListener('click', () => setupAuthFormListeners('login'));
            genericModal.querySelector('#signup-tab').addEventListener('click', () => setupAuthFormListeners('signup'));
            
            genericModal.querySelector('#auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const errorEl = genericModal.querySelector('#auth-error');
                errorEl.textContent = '';
                try {
                    tempAnonymousUserId = auth.currentUser?.uid;
                    if (initialView === 'login') {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    closeGenericModal();
                } catch(error) {
                    tempAnonymousUserId = null;
                    errorEl.textContent = error.message;
                }
            });
        }

        // ==== FIREBASE FUNCTIONS ====
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCEMWns_UkJoxoAttHlhQHTuitc9ptUTxI",
                    authDomain: "eshop-27a96.firebaseapp.com",
                    projectId: "eshop-27a96",
                    storageBucket: "eshop-27a96.firebasestorage.app",
                    messagingSenderId: "855173438737",
                    appId: "1:855173438737:web:42a28023eff674aa0d80b0"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await fetchSiteSettings(); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAnonymous = user.isAnonymous;
                        if (!isAnonymous && tempAnonymousUserId && tempAnonymousUserId !== userId) {
                            await mergeAnonymousCartWithUser(tempAnonymousUserId, userId);
                            tempAnonymousUserId = null;
                        } else {
                           tempAnonymousUserId = isAnonymous ? userId : null;
                        }
                        await setupCartListener();
                        await fetchProducts();
                        await fetchBanners();
                        await fetchCategories();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                             if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                                loadingSpinner.classList.add('hidden');
                                productGrid.innerHTML = `<p class="col-span-full text-center text-red-500 p-8 rounded-lg bg-red-50 border border-red-200"><strong>Configuration Error:</strong> Anonymous sign-in is not enabled. Please enable it in your Firebase Authentication settings.</p>`;
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingSpinner.classList.add('hidden');
                productGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to connect to the database. ${error.message}</p>`;
            }
        }
        
        async function mergeAnonymousCartWithUser(anonymousId, permanentId) {
            const anonCartRef = collection(db, `users/${anonymousId}/cart`);
            const userCartRef = collection(db, `users/${permanentId}/cart`);
            const anonCartSnapshot = await getDocs(anonCartRef);
            if (anonCartSnapshot.empty) return;
            await runTransaction(db, async (transaction) => {
                for (const anonDoc of anonCartSnapshot.docs) {
                    const item = anonDoc.data();
                    const userCartQuery = query(userCartRef, where("id", "==", item.id), where("size", "==", item.size));
                    const userCartSnapshot = await transaction.get(userCartQuery);
                    if (!userCartSnapshot.empty) {
                        const userDocRef = userCartSnapshot.docs[0].ref;
                        const newQuantity = userCartSnapshot.docs[0].data().quantity + item.quantity;
                        transaction.update(userDocRef, { quantity: newQuantity });
                    } else {
                        const newUserItemRef = doc(userCartRef);
                        transaction.set(newUserItemRef, item);
                    }
                    transaction.delete(anonDoc.ref);
                }
            });
        }
        
        async function fetchSiteSettings() {
            const settingsRef = doc(db, 'settings', 'main');
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    siteSettings = docSnap.data();
                    applySiteSettings();
                } else {
                    console.log("No settings document found!");
                }
            });
        }
        
        function applySiteSettings() {
            document.getElementById('footer-brand-info').textContent = siteSettings.brandInfo || '';
            const infoLinks = `<li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="About Us" data-modal-content-key="aboutUs">About Us</a></li><li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="Contact Us" data-modal-content-key="contactUs">Contact Us</a></li><li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="FAQ" data-modal-content-key="faq">FAQ</a></li>`;
            document.getElementById('footer-info-links').innerHTML = infoLinks;
            const guidelinesLinks = `<li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="Terms & Condition" data-modal-content-key="terms">Terms & Condition</a></li><li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="Privacy Policy" data-modal-content-key="privacy">Privacy Policy</a></li><li><a href="#" class="hover:text-indigo-400 transition" data-modal-title="Return Policy" data-modal-content-key="returnPolicy">Return Policy</a></li>`;
            document.getElementById('footer-guidelines-links').innerHTML = guidelinesLinks;
            const socialLinks = `<a href="${siteSettings.facebookUrl || '#'}" target="_blank" class="text-gray-400 hover:text-indigo-400 transition"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg></a><a href="${siteSettings.twitterUrl || '#'}" target="_blank" class="text-gray-400 hover:text-indigo-400 transition"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.71v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" /></svg></a><a href="${siteSettings.instagramUrl || '#'}" target="_blank" class="text-gray-400 hover:text-indigo-400 transition"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 ..."/></svg></a>`;
            document.getElementById('footer-social-links').innerHTML = socialLinks;
        }

        async function fetchProducts() {
            if (products.length > 0) return; 
            try {
                const productsCollectionRef = collection(db, "products");
                const querySnapshot = await getDocs(productsCollectionRef);
                products = querySnapshot.docs.map(doc => ({ id: isNaN(parseInt(doc.id)) ? doc.id : parseInt(doc.id), ...doc.data() }));
                renderProducts(products);
            } catch(e) {
                 console.error("Error fetching products:", e);
                 if (e.message.includes("permissions")) {
                     loadingSpinner.classList.add('hidden');
                     productGrid.innerHTML = `<p class="col-span-full text-center text-red-500 p-8"><strong>Permission Error:</strong> Could not fetch products. Please check Firestore Rules.</p>`;
                 }
            }
        }

        async function fetchBanners() {
            const q = query(collection(db, "banners"));
            onSnapshot(q, s => { banners = s.docs.map(d => ({ id: d.id, ...d.data() })); renderBanners(); }, e => { console.error(e); });
        }

        async function fetchCategories() {
            const q = query(collection(db, "categories"), orderBy("name"));
            onSnapshot(q, s => { categories = s.docs.map(d => d.data().name); renderCategories(); }, e => console.error(e));
        }
        
        async function setupCartListener() {
            if (unsubscribeCartListener) unsubscribeCartListener(); 
            if (!userId) return;
            const cartRef = collection(db, `users/${userId}/cart`);
            unsubscribeCartListener = onSnapshot(cartRef, s => { cart = s.docs.map(d => ({ docId: d.id, ...d.data() })); updateCartUI(); }, e => console.error(e));
        }


        // ==== APP INITIALIZATION ====
        function init() {
            initializeFirebase();
            document.querySelector('footer').addEventListener('click', (e) => {
                const link = e.target.closest('a[data-modal-content-key]');
                if (link) {
                    e.preventDefault();
                    const title = link.dataset.modalTitle;
                    const contentKey = link.dataset.modalContentKey;
                    showTextModal(title, siteSettings[contentKey]);
                }
            });
            setupPaymentModalListeners();
            profileIcon.addEventListener('click', () => {
                const content = isAnonymous ? getAuthViewHTML('login') : getProfileViewHTML();
                openGenericModal(content);
                if (isAnonymous) {
                    setupAuthFormListeners('login');
                } else {
                    document.getElementById('logout-btn').addEventListener('click', async () => { await signOut(auth); closeGenericModal(); });
                }
            });
            genericModalOverlay.addEventListener('click', (e) => { if(e.target === genericModalOverlay) closeGenericModal() });
            
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            const hash = window.location.hash;
            if(hash.startsWith('#product/')) { 
                const id = parseInt(hash.split('/')[1]); 
                const interval = setInterval(() => { if (products.length > 0) { clearInterval(interval); if(id) showProductDetail(id); } }, 100);
            } else if (hash === '#checkout') { 
                 const interval = setInterval(() => { if (cart.length > 0) { clearInterval(interval); showCheckout(); } }, 100);
            } else { 
                history.replaceState({ page: 'main' }, '', '#'); 
            }
        }

        init();
    </script>
</body>
</html>

